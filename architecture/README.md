# Webproシステム アーキテクチャドキュメント

## 概要

このディレクトリには、Webpro（建築物省エネ基準 非住宅建築物 一次エネルギー消費量算定方法）システムの包括的なアーキテクチャドキュメントが含まれています。

**作成日:** 2026年1月11日
**バージョン:** 3.0β
**プロジェクト:** BESJP_EngineeringReference

---

## ドキュメント一覧

### 1. [システム全体アーキテクチャ](./01_system_overview.md)
**ファイル:** `01_system_overview.md`

**内容:**
- システム全体の3層構造
- 各層の責務と技術スタック
- 情報の流れ
- 公開URLと開発・運用体制

**主要図表:**
- システム全体アーキテクチャ図（3層構造）
- レイヤー別責務の説明
- 技術スタック一覧

---

### 2. [データフロー図](./02_data_flow.md)
**ファイル:** `02_data_flow.md`

**内容:**
- 全体データフロー（入力→変換→計算→出力）
- CSV→XML変換の詳細フロー
- 計算エンジンのデータフロー（空調計算の例）
- 計算結果の統合フロー
- データの依存関係

**主要図表:**
- 全体データフロー図
- CSV→XML変換詳細フロー
- 空調計算の詳細フロー
- 負荷率帯分類の詳細
- 計算結果統合フロー
- データ依存関係図

---

### 3. [エンティティ関係図（ER図）](./03_entity_relationship.md)
**ファイル:** `03_entity_relationship.md`

**内容:**
- 全体エンティティ関係図（33エンティティ）
- 空調システムの詳細ER図
- エンティティのカーディナリティ一覧
- 主要な外部キー関係
- 7つの論理ビュー（ページ）
- 複雑なリレーションの詳細
- データ整合性制約
- エンティティ数とデータボリューム見積もり

**主要図表:**
- 全33エンティティのER図（Mermaid形式）
- 空調システムの詳細ER図
- カーディナリティ一覧表
- 外部キー関係図
- データボリューム見積もり表

---

### 4. [CI/CDパイプラインとデプロイメント](./04_cicd_deployment.md)
**ファイル:** `04_cicd_deployment.md`

**内容:**
- CI/CDパイプライン全体図
- CircleCIワークフロー詳細
- ビルドスクリプト詳細
- Dockerコンテナ構成
- GitHub Pages デプロイメント
- ブランチ戦略
- 環境変数とシークレット管理
- ビルド時間とパフォーマンス
- エラーハンドリング
- セキュリティ考慮事項

**主要図表:**
- CI/CDパイプライン全体図
- CircleCIワークフローシーケンス図
- Asciidoctor変換フロー
- Dockerコンテナライフサイクル
- GitHub Pages デプロイフロー
- Gitブランチ戦略図

---

### 5. [計算エンジンの構成](./05_calculation_engine.md)
**ファイル:** `05_calculation_engine.md`

**内容:**
- 計算エンジン全体アーキテクチャ
- 空調計算モジュールの詳細構成
- 計算モジュール間のデータフロー
- 負荷計算エンジンの詳細
- エネルギー消費量計算エンジン
- 計算エンジンの実装パターン
- パフォーマンス最適化戦略
- エラーハンドリングと例外処理

**主要図表:**
- 計算エンジン全体アーキテクチャ図
- 空調計算モジュール詳細図
- 計算モジュール間データフロー
- 室負荷計算エンジン詳細図
- 負荷率帯分類エンジン図
- 空調機消費電力計算フロー
- 熱源消費電力計算フロー
- オブジェクト指向設計クラス図
- 並列計算可能性図
- エラーハンドリングフロー

---

## システムの特徴

### 1. 仕様駆動型設計

Webproシステムは**実装システムではなく、計算仕様書・入出力変換仕様書のドキュメント管理プロジェクト**です。

- **ドキュメントが真実のソース（Single Source of Truth）**
- 計算実装はこの仕様に従う
- 複数の実装（Java、Python等）が可能

### 2. 3層構造

```
第1層: 計算仕様書（EngineeringReference）
         ↓
第2層: 入出力変換仕様（csv2xml）
         ↓
第3層: データスキーマ（A5:ER）
         ↓
自動ビルド・デプロイ（CircleCI + GitHub Pages）
```

### 3. 完全な透明性

- すべての計算根拠を公開
- GitHubでオープンソース化
- 誰でもアクセス・検証可能

### 4. 継続的改善

- CircleCIで自動ビルド
- masterブランチ更新時に自動デプロイ
- バージョン履歴の完全な追跡

---

## 技術スタック

| レイヤー | 技術 | 用途 |
|---------|------|------|
| ドキュメント記述 | **AsciiDoc** | 仕様書の記述 |
| 数式表記 | **LaTeX (stem記法)** | 計算式の表現 |
| ER図 | **A5:ER (A5:SQL Mk-2)** | データスキーマ定義 |
| ビルド | **Docker + Asciidoctor** | HTML生成 |
| CI/CD | **CircleCI** | 自動ビルド・デプロイ |
| ホスティング | **GitHub Pages** | 公開サイト |
| バージョン管理 | **Git/GitHub** | ソース管理 |
| 図表記述 | **Mermaid** | アーキテクチャ図作成 |

---

## データ統計

### エンティティ数

- **総エンティティ数:** 33
- **リレーション数:** 24
- **主キー数:** 33
- **インデックス数:** 32

### ドキュメント数

- **計算仕様書:** 9章（合計約1MB）
- **CSV→XML変換仕様:** 23ファイル
- **E-R図:** 7ページ（論理ビュー）

### 入力項目数

- **CSV入力様式:** 22様式（様式0～8）
- **総フィールド数:** 約180～200個
- **列挙型フィールド数:** 約45個

---

## ファイル構造

```
BESJP_EngineeringReference/
├── architecture/                          # このディレクトリ
│   ├── README.md                          # このファイル
│   ├── 01_system_overview.md              # システム全体概要
│   ├── 02_data_flow.md                    # データフロー図
│   ├── 03_entity_relationship.md          # ER図
│   ├── 04_cicd_deployment.md              # CI/CDパイプライン
│   └── 05_calculation_engine.md           # 計算エンジン
├── EngineeringReference_chapter*.adoc     # 計算仕様書（9章）
├── csv2xml/                               # CSV→XML変換仕様（23ファイル）
├── webpro_input_schema.a5er               # E-R図（A5:ER形式）
├── docs/                                  # 生成されたHTML（公開サイト）
├── docker-compose.yml                     # Dockerビルド設定
├── convert_adoc_to_html.sh                # ビルドスクリプト
├── .circleci/config.yml                   # CI/CD設定
└── README.md                              # プロジェクトREADME
```

---

## 主要なURL

### 公開サイト

**メインサイト:**
https://webpro-nr.github.io/BESJP_EngineeringReference/index.html

**CSV→XML変換仕様:**
https://webpro-nr.github.io/BESJP_EngineeringReference/csv2xml/index.html

### GitHubリポジトリ

https://github.com/WEBPRO-NR/BESJP_EngineeringReference

---

## 計算フローの概要

```
CSV入力シート（様式0～8）
         ↓
CSV→XML変換（本プロジェクトの仕様）
         ↓
XML形式統合データ
         ↓
計算エンジン（別システム実装）
  ├─ 第2章: 空調計算（気象条件、室負荷、空調機、ポンプ、熱源）
  ├─ 第3章: 換気計算（送風機消費電力）
  ├─ 第4章: 照明計算（照明消費電力、制御効果）
  ├─ 第5章: 給湯計算（給湯負荷、配管損失、効率）
  ├─ 第6章: 昇降機計算（エレベータ消費電力）
  ├─ 第7章: 太陽光発電（発電量、自己消費）
  ├─ 第8章: コージェネ（発電、排熱利用）
  ├─ 第9章: その他（OA機器等原単位）
  └─ 第10章: 基準値計算（室用途別標準値）
         ↓
第1章: 統合計算
  E_T = (E_AC + E_V + E_L + E_HW + E_EV - E_PV - E_CGS + E_M) × 10^-3
         ↓
結果出力
  • 設計一次エネルギー消費量 E_T [GJ/年]
  • 基準一次エネルギー消費量 E_ST [GJ/年]
  • BEI = E_T / E_ST
  • 設備別内訳
```

---

## データフローの概要

### 入力データ

| データ種別 | データ量 | 説明 |
|----------|---------|------|
| CSV入力シート | 1～10KB/様式 | 1建物あたり |
| XML統合データ | 50～500KB | 1建物あたり（規模による） |
| 気象データ | 約350KB | 8760時間×8地域 |
| 定数・係数データ | 数MB | 建材、機器特性等 |

### 計算データ

| 計算対象 | 時間粒度 | データ点数 |
|---------|---------|----------|
| 気象条件 | 1時間 | 8760点/年 |
| 室負荷計算 | 1時間 | 8760点/年/室 |
| 空調機負荷 | 1時間 → 負荷率帯 | 8760点 → 11区分 |
| 給湯負荷 | 1日 | 365点/年 |
| 最終結果 | 年間積算 | 1点/年 |

---

## パフォーマンス

### ビルド時間

| フェーズ | 時間 | 説明 |
|---------|-----|------|
| CircleCIビルド | 1～2分 | AsciiDoc→HTML変換 + コミット&プッシュ |
| GitHub Pagesデプロイ | 2～4分 | Jekyll処理 + CDN配信 |
| **合計** | **3～6分** | push後から公開まで |

### 計算時間（見積もり、中規模建物）

| 計算フェーズ | 時間 | 説明 |
|-----------|-----|------|
| 空調負荷計算 | 10～30秒 | 8760h×50室＝438,000計算 |
| 空調機消費電力 | 2～5秒 | 負荷率帯×外気温帯×機器数 |
| その他設備計算 | 5～10秒 | 換気・照明・給湯・昇降機 |
| **合計（シングルスレッド）** | **20～50秒** | |
| **並列実行時** | **10～20秒** | 6コア並列の場合 |

---

## セキュリティとアクセス制御

| リソース | アクセス権 | 制御方法 |
|---------|----------|---------|
| GitHubリポジトリ | public（読取）/ 限定（書込） | GitHub Organization設定 |
| CircleCI | チームメンバーのみ | CircleCI Project設定 |
| GitHub Pages | public（全世界公開） | 制御不可 |
| シークレット | 管理者のみ | CircleCI Environment Variables |

---

## 開発・運用体制

**開発元:**
- 国土交通省 国土技術政策総合研究所
- 国立研究開発法人 建築研究所

**バージョン:**
- 現在: 3.0β（開発中）
- 公開中: 2.x（平成25年基準対応）

**更新頻度:**
- masterブランチへのpush時に自動デプロイ
- 計算仕様の改訂時に章別更新

**品質管理:**
- GitHubプルリクエストによるレビュー
- CircleCIによる自動ビルドチェック
- 誤字・数式エラーの継続的修正

---

## 図表の見方

### Mermaid記法

すべてのアーキテクチャ図は**Mermaid記法**で記述されています。

**表示方法:**
1. **GitHub上で表示:** GitHubは自動的にMermaid図をレンダリングします
2. **VS Code:** Mermaid Preview拡張機能をインストール
3. **オンラインエディタ:** https://mermaid.live/ にコードをコピー&ペースト

**図の種類:**
- `flowchart`: フローチャート（データフロー、プロセスフロー）
- `erDiagram`: エンティティ関係図
- `sequenceDiagram`: シーケンス図
- `classDiagram`: クラス図
- `graph`: グラフ（依存関係等）
- `stateDiagram`: 状態遷移図

---

## 用語集

### 主要な用語

| 用語 | 説明 |
|-----|------|
| **Webpro** | 建築物省エネ基準 非住宅建築物 一次エネルギー消費量算定方法のWebプログラム |
| **BESJP** | Building Energy Simulation for Japan（日本の建物エネルギーシミュレーション） |
| **一次エネルギー** | 化石燃料、原子力、自然エネルギー等、変換加工されていないエネルギー |
| **BEI** | Building Energy Index（建築物省エネルギー性能表示指標）= E_T / E_ST |
| **E_T** | 設計一次エネルギー消費量 [GJ/年] |
| **E_ST** | 基準一次エネルギー消費量 [GJ/年] |
| **負荷率帯** | 空調負荷を定格能力で除した値を11区分に分類したもの（0-10%, 10-20%, ..., 100%以上） |
| **CASCADE** | 既存のエネルギー計算プログラム（コージェネ計算用） |
| **AsciiDoc** | 軽量マークアップ言語（ドキュメント記述用） |
| **Mermaid** | テキストベースの図表記述言語 |
| **A5:ER** | データベース設計ツール（ER図作成用） |

### 設備用語

| 用語 | 説明 |
|-----|------|
| **空調ゾーン** | 空調条件が同一とみなせる複数の室をまとめたもの |
| **熱源群** | 複数の熱源機器を統合した単位 |
| **二次ポンプ** | 熱源と空調機の間で冷温水を循環させるポンプ |
| **全熱交換器** | 排気の熱を給気に回収する装置 |
| **負荷率** | 実際の負荷を定格能力で除した値 |
| **COP** | Coefficient of Performance（成績係数、エネルギー効率） |
| **熱貫流率（U値）** | 壁や窓の熱の伝わりやすさ [W/(m²・K)] |
| **日射熱取得率（η値）** | 窓から侵入する日射熱の割合 |

---

## 参考資料

### 国交省告示・通知

- 平成28年国土交通省告示第265号
- 平成28年省エネルギー基準関係技術資料

### 研究報告書

- 建築研究資料第201号～190号系列
- 国総研資料第1107号～765号系列

### 外部データソース

- 拡張アメダス気象データ 標準年1995年版（株式会社気象データシステム）
- 建材物性値データベース
- 機器特性データベース

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2026-01-11 | 1.0 | 初版作成（5つのアーキテクチャドキュメント） |

---

## ライセンス

本ドキュメントは、BESJP_EngineeringReferenceプロジェクトの一部として、プロジェクトと同じライセンスの下で提供されます。

詳細は、プロジェクトルートの[LICENSE](../LICENSE)ファイルを参照してください。

---

## 問い合わせ

GitHubリポジトリ: https://github.com/WEBPRO-NR/BESJP_EngineeringReference

Issue: https://github.com/WEBPRO-NR/BESJP_EngineeringReference/issues

---

**このアーキテクチャドキュメントは、Webproシステムの全体像を理解し、計算仕様の実装や拡張を行うための包括的なガイドです。**
